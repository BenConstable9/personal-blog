---
title: "Flake Only Changed Python Files"
date: 2023-04-24T15:31:44+01:00
tags: ["Azure DevOps", "Python", "Flake8"]
draft: false
author: "Me"
showToc: true
TocOpen: false
draft: false
hidemeta: false
comments: false
searchHidden: false
ShowReadingTime: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
ShowWordCount: true
---

Have you ever needed to run linting or flake only on select Python files during build validation checks on Pull Requests on Azure DevOps?

In some cases, such as adopting Flake8 onto a large-scale existing project, you may only want to enforce Flake8 checks on the changed files in a PR.

### Setting Shallow Fetch 

During PR creation, Azure DevOps creates a merge branch with all the changes in a single commit. Setting ShallowFetchDepth to 2 ensures that the difference can be generated by downloading the target branch state.

```yaml
variables:
  - name: Agent.Source.Git.ShallowFetchDepth
    value: 2
```

### Set Up Python Requirements

Set up a Python environment with your testing requirements from *requirements-test.txt*. In this instance, *requirements-test.txt* only contains Flake8 and Flake8_junit.

```yaml
- task: UsePythonVersion@0
    displayName: "Use Python 3.9"
    inputs:
        versionSpec: 3.9
        architecture: "x64"

    - task: Powershell@2
    displayName: "Upgrade Pip"
    inputs:
        targetType: "inline"
        script: "python -m pip install --upgrade pip"

    - task: Powershell@2
    displayName: "Install test requirements"
    inputs:
        targetType: "inline"
        script: "python -m pip install -r ./requirements-test.txt"
```

### Generate Differences & Flaking

To flake only changed files, use *git diff* with *xargs* to pipe the result to the flaking command:

- *git diff HEAD~ HEAD* generates the difference between the source branch and the target branch.

- *--diff-filter=ACMRT* filters out any deleted files. Without this, if files are deleted during a pull request, linting will fail as they do not exist.

- *xargs -r* is used to send the contents of *$workingDirectoryChangedFiles* to the linting command; in this case, we are using Flake8 with a redirection to an output file*--no-run-if-empty (-r)* is used to prevent Flake8 from failing.

- Variable *PythonFilesChanged* is set to ensure that if no Python files are included in the Pull Request, further tasks that use the generated report do not fail.

```yaml
- task: Powershell@2
    displayName: "Validate Flake8 Compliance"
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    inputs:
        targetType: "inline"
        script: |
        mkdir $(Pipeline.Workspace)/lint-tests

        $workingDirectoryChangedFiles = $(git diff --name-only --diff-filter=ACMRT HEAD~ HEAD | grep -i "*\.py$")
        
        echo $workingDirectoryChangedFiles | xargs -r -t flake8 --tee --output-file $(Pipeline.Workspace)/lint-tests/lint-results.txt

        if($workingDirectoryChangedFiles.Length -gt 0) {
            Write-Output "##vso[task.setvariable variable=PythonFilesChanged]True"
        } else {
            Write-Output "##vso[task.setvariable variable=PythonFilesChanged]False"
        }
        workingDirectory: "$(Build.Repository.LocalPath)"
```

### Generate Report

Azure DevOps supports including test results in Pull Request summaries, which allows for clear visualization of the report results without needing to dive into the pipeline runs. 

* *flake8_junit* is used to convert the Flake8 output file into a JUnit format that is readable by Azure DevOps.

* *PublishTestResults@2* uploads the generated XML file to Azure DevOps and publishes it once the pipeline is completed.

```yaml
- task: Powershell@2
    displayName: "Generate Flake8 Report"
    condition: and(succeeded(), or(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['PythonFilesChanged'], True)))
    inputs:
        targetType: "inline"
        script: "flake8_junit $(Pipeline.Workspace)/lint-tests/lint-results.txt $(Pipeline.Workspace)/lint-tests/lint-results.xml"
        workingDirectory: "$(Build.Repository.LocalPath)"

- task: PublishTestResults@2
displayName: "Publish Flake8 Report"
    condition: and(succeeded(), or(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['PythonFilesChanged'], True)))
    inputs:
        testResultsFormat: "JUnit"
        testResultsFiles: "$(Pipeline.Workspace)/lint-tests/lint-results.xml"
        mergeTestResults: false
        failTaskOnFailedTests: false
        testRunTitle: "Python Flake8"
```

### Branch Policy

Add a build validation step referencing the YAML pipeline to automatically run this on future Pull Requests.